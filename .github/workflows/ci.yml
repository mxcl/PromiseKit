name: CI

on:
  workflow_dispatch:
  workflow_call:
  pull_request:
    paths:
      - Sources/**
      - Tests/**
      - .github/workflows/ci.yml
      - PromiseKit.xcodeproj/**

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        swift:
        - 4.0.3
        - 4.1.3
        - 4.2.4
    container:
      image: swift:${{ matrix.swift }}
    steps:
    - uses: actions/checkout@v2
    - run: swift build -Xswiftc -warnings-as-errors -Xswiftc -swift-version -Xswiftc 3
    - run: swift build  # generated linuxmain requires Swift 5 sadly

  linux-code-cov:
    name: linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        swift:
        - '5.0'
        - 5.1
        - 5.2
        - 5.3
        - 5.4
        - 5.5
        - 5.6
    container:
      image: swift:${{ matrix.swift }}
    steps:
    - uses: actions/checkout@v2
    - run: swift build -Xswiftc -warnings-as-errors -Xswiftc -swift-version -Xswiftc 4
    - run: swift build -Xswiftc -warnings-as-errors -Xswiftc -swift-version -Xswiftc 4.2
    - run: swift test --enable-code-coverage --parallel

    - name: Generate Coverage Report
      if: ${{ matrix.swift < 5.4 }}  # fails for SOME REASON
      run: |
        apt-get -qq update
        apt-get -qq install llvm-10 curl
        export b=$(swift build --show-bin-path) && llvm-cov-10 \
          export -format lcov \
          -instr-profile=$b/codecov/default.profdata \
          --ignore-filename-regex='\.build/' \
          $b/*.xctest \
          > info.lcov
    - uses: codecov/codecov-action@v1
      with:
        file: ./info.lcov

  verify-linuxmain:
    runs-on: macos-latest
    name: linux (validate manifests)
    steps:
    - uses: actions/checkout@v2
    - run: swift test --generate-linuxmain
    - run: git diff --exit-code

  test:
    runs-on: macos-14
    strategy:
      matrix:
        dst:
        - "platform:macOS,arch:arm64,id:0000FE00-392BB8A41C01F642"
        #- "platform:tvOS Simulator,id:0EB16E3F-8F5F-4EEF-BFEC-18C3A4FAB91C,OS:17.2,name:Apple TV"
        #- "platform:iOS Simulator,id:5AC1B28F-A59B-4ADC-B89A-9A7DBC14C752,OS:17.0.1,name:iPhone 15"
        #- "platform:watchOS Simulator,id:821F9864-6742-4DE4-BD95-A5A252620E09,OS:10.2,name:Apple Watch Series 9 (45mm)"
    steps:
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 15.2
    - uses: actions/checkout@v2
    - uses: sersoft-gmbh/xcodebuild-action@v1
      with:
        project: PromiseKit.xcodeproj
        scheme: PromiseKit
        destination: ${{ matrix.dst }}
        action: test
        enable-code-coverage: true
    - uses: codecov/codecov-action@v1
